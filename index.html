<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Steinmetz Core Loss Calculator</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body { font-family: Arial; max-width:800px; margin:2rem auto; line-height:1.5; }
    label { display:block; margin:.5rem 0 .2rem; }
    input, select, button { width:100%; padding:.5rem; font-size:1rem; margin-bottom:.5rem; }
    button { margin-top:.5rem; }
    #result { margin:1rem 0; font-weight:bold; }
    .hidden { display:none; }
    #graph { width:100%; height:400px; }
    #formulas { margin-top:2rem; border-top:1px solid #ccc; padding-top:1rem; }
    /* New grid for parameters */
    .param-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: .5rem; }
    .param-grid > div { display: flex; flex-direction: column; }
  </style>
</head>
<body>
  <h1>Steinmetz Core Loss Calculator</h1>

  <!-- Model Selection -->
  <label>Model Selection:</label>
  <select id="model">
    <option value="CSE">Classical (CSE)</option>
    <option value="MSE">Modified (MSE)</option>
    <option value="GSE">Generalized (GSE)</option>
    <option value="iGSE">Improved GSE (iGSE)</option>
  </select>

  <!-- Grouped Input Parameters -->
  <div class="param-grid">
    <div>
      <label>Frequency f (kHz):</label>
      <input type="number" id="f" value="1" step="any">
    </div>
    <div>
      <label>Peak Magnetic Flux Density Bₚₖ (mT):</label>
      <input type="number" id="Bpk" value="100" step="any">
    </div>
    <div>
      <label>Core Volume Ve (cm³):</label>
      <input type="number" id="volume" value="100" step="any">
    </div>
  </div>

  <div id="params-CSE" class="hidden">
    <label>k:</label><input type="number" id="k" value="1e-3" step="any">
    <label>α:</label><input type="number" id="alpha" value="1.6" step="any">
    <label>β:</label><input type="number" id="beta" value="2.2" step="any">
  </div>
  <div id="params-MSE" class="hidden">
    <label>kₕ:</label><input type="number" id="kh" value="1e-3" step="any">
    <label>kₑ:</label><input type="number" id="ke" value="1e-6" step="any">
    <label>α:</label><input type="number" id="alpha2" value="1.6" step="any">
    <label>β:</label><input type="number" id="beta2" value="2.2" step="any">
  </div>
  <div id="params-GSE" class="hidden">
    <p>Sinusoidal Wave \(B(t)=B_{pk}\sin(2\pi f t)\) Numerical Integration</p>
    <label>kᵢ:</label><input type="number" id="ki" value="1e-6" step="any">
    <label>α:</label><input type="number" id="alpha3" value="1.6" step="any">
    <label>β:</label><input type="number" id="beta3" value="2.2" step="any">
    <label>Integration Steps:</label><input type="number" id="steps" value="500" step="1">
  </div>
  <div id="params-iGSE" class="hidden">
    <p>iGSE: Time Integration of MSE</p>
    <label>kₕ:</label><input type="number" id="kh2" value="1e-3" step="any">
    <label>kₑ:</label><input type="number" id="ke2" value="1e-6" step="any">
    <label>α:</label><input type="number" id="alpha4" value="1.6" step="any">
    <label>βₕ:</label><input type="number" id="beta4" value="2.2" step="any">
    <label>Integration Steps:</label><input type="number" id="steps2" value="500" step="1">
  </div>

  <button id="computeBtn">P<sub>v</sub> Calculation</button>
  <div id="result"></div>

  <h3>Graph: Freq.·B Range</h3>
  <label>Frequency (kHz):</label>
  <input type="number" id="fMin" value="0.1" step="any">
  <input type="number" id="fMax" value="100" step="any">
  <label>Frequency sweeps:</label><input type="number" id="fSteps" value="30">
  <label>B range (mT):</label>
  <input type="number" id="BMin" value="10" step="any">
  <input type="number" id="BMax" value="200" step="any">
  <label>No. of sweeps:</label><input type="number" id="BSteps" value="30">
  <button id="plotBtn">Draw a Plot</button>
  <div id="graph"></div>

  <div id="formulas">
    <h3>Steinmetz Equations</h3>
    <p>Classical (CSE):<br>
       $$P_v = k\,f^{\alpha}\,B_{pk}^{\beta}$$</p>
    <p>Modified (MSE):<br>
       $$P_v = k_h\,f^{\alpha}\,B_{pk}^{\beta} + k_e\,f\,B_{pk}^2$$</p>
    <p>Generalized (GSE):<br>
       $$P_v = \frac{1}{T}\int_0^T k_i\bigl|\tfrac{dB}{dt}\bigr|^{\alpha}\,|B|^{\beta}\,dt$$</p>
    <p>Improved GSE (iGSE):<br>
       $$P_v = \frac{1}{T}\int_0^T\Bigl(k_h|B|^{\beta_H}+k_e f|B|^2\Bigr)\bigl|\tfrac{dB}{dt}\bigr|^{\alpha_H}dt$$</p>
  </div>

  <script>
    function getValue(id){ return parseFloat(document.getElementById(id).value); }
    document.addEventListener('DOMContentLoaded', ()=>{
      const modelEl = document.getElementById('model');
      const sections = { CSE:'params-CSE', MSE:'params-MSE', GSE:'params-GSE', iGSE:'params-iGSE' };
      function toggleSections(){
        Object.keys(sections).forEach(key => {
          document.getElementById(sections[key]).classList.toggle('hidden', key !== modelEl.value);
        });
      }
      modelEl.addEventListener('change', toggleSections);
      toggleSections();
      document.getElementById('computeBtn').addEventListener('click', compute);
      document.getElementById('plotBtn').addEventListener('click', plotGraph);
    });
    function compute(){
      const f_kHz = getValue('f');
      const f = f_kHz;
      const Bpk_mT = getValue('Bpk');
      const Bpk = Bpk_mT ;
      const Vcc = getValue('volume');
      const T = 1/f;
      let Pv = 0;

      const model = document.getElementById('model').value;
      if(model==='CSE'){
        const k = getValue('k'), α = getValue('alpha'), β = getValue('beta');
        Pv = k * Math.pow(f,α) * Math.pow(Bpk,β);
      }
      else if(model==='MSE'){
        const kh = getValue('kh'), ke = getValue('ke'),
              α = getValue('alpha2'), β = getValue('beta2');
        Pv = kh*Math.pow(f,α)*Math.pow(Bpk,β)
           + ke * f * Math.pow(Bpk,2);
      }
      else if(model==='GSE'){
        const ki = getValue('ki'), α = getValue('alpha3'),
              β = getValue('beta3'), steps = getValue('steps');
        let sum=0, dt=T/steps;
        for(let i=0;i<steps;i++){
          const t=i*dt;
          const Bt = Bpk*Math.sin(2*Math.PI*f*t);
          const dBdt = 2*Math.PI*f*Bpk*Math.cos(2*Math.PI*f*t);
          sum += Math.pow(Math.abs(dBdt),α)*Math.pow(Math.abs(Bt),β)*dt;
        }
        Pv = ki/T * sum;
      }
      else if(model==='iGSE'){
        const kh2 = getValue('kh2'), ke2 = getValue('ke2'),
              α = getValue('alpha4'), βh = getValue('beta4'),
              steps2 = getValue('steps2');
        let sum=0, dt=T/steps2;
        for(let i=0;i<steps2;i++){
          const t=i*dt;
          const Bt = Bpk*Math.sin(2*Math.PI*f*t);
          const dBdt = 2*Math.PI*f*Bpk*Math.cos(2*Math.PI*f*t);
          const hyst = kh2*Math.pow(Math.abs(dBdt),α)*Math.pow(Math.abs(Bt),βh);
          const eddy = ke2*Math.pow(Math.abs(dBdt),1)*Math.pow(Math.abs(Bt),2);
          sum += (hyst+eddy)*dt;
        }
        Pv = sum/T;
      }

      const Pcv = Pv;          // mW/cc
      const P = Pv * Vcc;      // mW

      document.getElementById('result').innerText =
        Pcv = ${Pcv.toFixed(3)} mW/cc (=kW/m³),   P = ${P.toFixed(3)} mW;
    }

    function linspace(min,max,n){
      const arr=[], step=(max-min)/(n-1||1);
      for(let i=0;i<n;i++) arr.push(min + step*i);
      return arr;
    }

    function plotGraph(){
      const fArr_kHz = linspace(
        getValue('fMin'),
        getValue('fMax'),
        getValue('fSteps')
      );
      const BArr_mT = linspace(
        getValue('BMin'),
        getValue('BMax'),
        getValue('BSteps')
      );
      const Z = [];
      // surface는 CSE 기준으로 계산 예시
      const k = getValue('k'), α = getValue('alpha'), β = getValue('beta');
      for(let i=0;i<BArr_mT.length;i++){
        const row=[];
        for(let j=0;j<fArr_kHz.length;j++){
          const Pv = k *
            Math.pow(fArr_kHz[j]*1e3,α) *
            Math.pow(BArr_mT[i]*1e-3,β);
          row.push(Pv);
        }
        Z.push(row);
      }

      Plotly.newPlot('graph',[{
        type:'surface',
        x: fArr_kHz,
        y: BArr_mT,
        z: Z,
        colorbar:{tickformat:'.1f'}
      }],{
        title:'Core Loss Surface (CSE)',
        scene:{
          xaxis:{title:'f (kHz)', tickformat:'.0f'},
          yaxis:{title:'B (mT)',  tickformat:'.0f'},
          zaxis:{title:'P_v (W/m³)', tickformat:'.0f'}
        }
      });
    }
  </script>
</body>
</html>
